---
    layout: post
    title: python监控网页状态
    tags:
    categories:
    ---
    <p>最近公司erp服务器无规律、不间断、时不时抽风，往往都是挂了快个把小时后其它部门的人才打电话过来说服务器挂了。于是用python写了一个简单的网页监控。程序主要监控网页状态码，200为正常，否则视为服务器挂了。每隔70秒查询一次，若发现三次连续的查询中都报错误，则通过预先设定的邮箱发送警告邮件。邮件发送后隔30分钟再次监控设定网页。</p>
<p>&nbsp;verson 1</p>
<p>直接将日志直接通过屏幕输出</p>
<div class="cnblogs_code">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">coding:utf-8</span><span style="color: #008000;">
#</span><span style="color: #008000;">author:ID404</span><span style="color: #008000;">
#</span><span style="color: #008000;">python verson 2.7.9</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> smtplib
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> urllib
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> time


</span><span style="color: #0000ff;">def</span><span style="color: #000000;"> sendmail():
    mail_to </span>= smtplib.SMTP(<span style="color: #800000;">'</span><span style="color: #800000;">smtp.126.com</span><span style="color: #800000;">'</span>,25)         <span style="color: #008000;">#</span><span style="color: #008000;">设置邮件发送服务器</span>
    mail_to.login(<span style="color: #800000;">"</span><span style="color: #800000;">send_mail@126.com</span><span style="color: #800000;">"</span>,<span style="color: #800000;">"</span><span style="color: #800000;">123456</span><span style="color: #800000;">"</span>)      <span style="color: #008000;">#</span><span style="color: #008000;">设置发送邮件的帐号,密码</span>
    msg = <span style="color: #800000;">"""</span><span style="color: #800000;">From: system &lt;send_mail@126.com&gt;    
To: &lt;receive_mail@126.com&gt;
Subject: webserver_down

web server is down 
</span><span style="color: #800000;">"""</span><span style="color: #000000;">
    mail_to.sendmail(</span><span style="color: #800000;">'</span><span style="color: #800000;">send_mail@126.com</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">receive_mail@126.com</span><span style="color: #800000;">'</span><span style="color: #000000;">,msg)
    mail_to.close()


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">'</span><span style="color: #800000;">__main__</span><span style="color: #800000;">'</span><span style="color: #000000;">:<br />    print time.strftime("%Y-%m-%d %H:%M:%S", time.localtime()),'server monitor is running'
    </span><span style="color: #0000ff;">while</span> 1<span style="color: #000000;">:
        count</span>=<span style="color: #000000;">0
        error_status_count</span>=<span style="color: #000000;">0
        </span><span style="color: #0000ff;">while</span> count&lt;3<span style="color: #000000;">:
            time.sleep(</span>70)      <span style="color: #008000;">#</span><span style="color: #008000;">每隔70秒监控一次服务器</span>
            <span style="color: #0000ff;">try</span><span style="color: #000000;">:
                status</span>=urllib.urlopen(<span style="color: #800000;">"</span><span style="color: #800000;">http://192.168.0.8</span><span style="color: #800000;">"</span>).code   <span style="color: #008000;">#</span><span style="color: #008000;">收集监控网址的网页状态码</span>
                <span style="color: #0000ff;">if</span> status==200<span style="color: #000000;">:
                    </span><span style="color: #0000ff;">print</span> time.strftime(<span style="color: #800000;">"</span><span style="color: #800000;">%Y-%m-%d %H:%M:%S</span><span style="color: #800000;">"</span>, time.localtime()),<span style="color: #800000;">'</span><span style="color: #800000;">web server is functional</span><span style="color: #800000;">'</span>
                <span style="color: #0000ff;">if</span> status&lt;&gt;200<span style="color: #000000;">:
                    error_status_count</span>+=1  
                    <span style="color: #0000ff;">print</span> time.strftime(<span style="color: #800000;">"</span><span style="color: #800000;">%Y-%m-%d %H:%M:%S</span><span style="color: #800000;">"</span>, time.localtime()),<span style="color: #800000;">'</span><span style="color: #800000;">web servier is down ,error status count:</span><span style="color: #800000;">'</span>,error_status_count,<span style="color: #800000;">'</span><span style="color: #800000;">status number</span><span style="color: #800000;">'</span><span style="color: #000000;">,status
            </span><span style="color: #0000ff;">except</span><span style="color: #000000;">:
                error_status_count</span>+=1    <span style="color: #008000;">#</span><span style="color: #008000;">网页状态错误次数进行累加</span>
                <span style="color: #0000ff;">print</span> time.strftime(<span style="color: #800000;">"</span><span style="color: #800000;">%Y-%m-%d %H:%M:%S</span><span style="color: #800000;">"</span>, time.localtime()),<span style="color: #800000;">'</span><span style="color: #800000;">web servier is down ,error status count:</span><span style="color: #800000;">'</span><span style="color: #000000;">,error_status_count
            count</span>+=1
        <span style="color: #0000ff;">if</span> error_status_count&gt;=3: <span style="color: #008000;">#</span><span style="color: #008000;">网页状态错误超过3次自动发送报警邮件</span>
            <span style="color: #0000ff;">print</span> <span style="color: #800000;">'</span><span style="color: #800000;">error status count is :</span><span style="color: #800000;">'</span>,error_status_count,<span style="color: #800000;">'</span><span style="color: #800000;">sending email,the program wiil try to monint the server after half an hour</span><span style="color: #800000;">'</span><span style="color: #000000;">
            sendmail()
            time.sleep(</span>1800)      <span style="color: #008000;">#</span><span style="color: #008000;">邮件发送后半小时再后再次监控网页</span>
    </pre>
</div>
<p>&nbsp;</p>
<p>verson 2&nbsp;</p>
<p>日志将在同目录下生成logs.txt</p>
<div class="cnblogs_code">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">coding:utf-8</span><span style="color: #008000;">
#</span><span style="color: #008000;">author:ID404</span><span style="color: #008000;">
#</span><span style="color: #008000;">python verson 2.7.9</span><span style="color: #008000;">
#</span><span style="color: #008000;">程序主要监控网页状态码，200为正常，否则视为服务器挂了。每隔70秒查询一次，若发现三次连续的查询中都报错误，则通过预先设定的邮箱发送警告邮件。邮件发送后隔30分钟再次监控设定网页。</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> smtplib
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> urllib
</span><span style="color: #0000ff;">from</span> datetime <span style="color: #0000ff;">import</span> *
<span style="color: #0000ff;">import</span><span style="color: #000000;"> time<br />from tkMessageBox import *

</span></pre>
<p>def sendmail():</p>
<pre></pre>
<p>&nbsp; &nbsp; send_mail="send_system@126.com"<br />&nbsp; &nbsp; send_mail_passwd="123456"<br />&nbsp; &nbsp; receive_mail='rec@126.com'<br />&nbsp; &nbsp; send_mail_server='smtp.126.com'<br />    <br />&nbsp; &nbsp; mail_to = smtplib.SMTP(send_mail_server,25)         <br />&nbsp; &nbsp; mail_to.login(send_mail,send_mail_passwd) <br />&nbsp; &nbsp; msg ="From: send_system &lt;"+send_mail+"""&gt;    <br />To: &lt;"""+receive_mail+"""&gt;<br />Subject: web server is down</p>
<pre></pre>
<p>web server is down <br />"""<br />&nbsp; &nbsp; mail_to.sendmail(send_mail,receive_mail,msg)<br />&nbsp; &nbsp; mail_to.close()</p>
<pre><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">'</span><span style="color: #800000;">__main__</span><span style="color: #800000;">'</span><span style="color: #000000;">:
    logs</span>=open(<span style="color: #800000;">'</span><span style="color: #800000;">./logs.txt</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">a+</span><span style="color: #800000;">'</span><span style="color: #000000;">)
    logs.writelines([</span><span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span>,str(datetime.now()),<span style="color: #800000;">'</span><span style="color: #800000;">    the program is running</span><span style="color: #800000;">'</span><span style="color: #000000;">])
    logs.close()
    </span><span style="color: #0000ff;">while</span> 1<span style="color: #000000;">:
        count</span>=<span style="color: #000000;">0
        error_status_count</span>=<span style="color: #000000;">0
        </span><span style="color: #0000ff;">while</span> count&lt;3<span style="color: #000000;">:
            time.sleep(</span>70)      <span style="color: #008000;">#</span><span style="color: #008000;">每隔70秒监控一次服务器</span>
            <span style="color: #0000ff;">try</span><span style="color: #000000;">:
                status</span>=urllib.urlopen(<span style="color: #800000;">"</span><span style="color: #800000;">http://192.168.0.8</span><span style="color: #800000;">"</span>).code   <span style="color: #008000;">#</span><span style="color: #008000;">收集监控网址的网页状态码</span>
                <span style="color: #0000ff;">if</span> status==200<span style="color: #000000;">:
                    logs</span>=open(<span style="color: #800000;">'</span><span style="color: #800000;">./logs.txt</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">a+</span><span style="color: #800000;">'</span><span style="color: #000000;">)
                    logs.writelines([</span><span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span>,str(datetime.now()),<span style="color: #800000;">'</span><span style="color: #800000;">    web server is functional</span><span style="color: #800000;">'</span><span style="color: #000000;">])
                    logs.close()                    
                </span><span style="color: #0000ff;">if</span> status&lt;&gt;200<span style="color: #000000;">:
                    error_status_count</span>+=1<span style="color: #000000;">
                    logs</span>=open(<span style="color: #800000;">'</span><span style="color: #800000;">./logs.txt</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">a+</span><span style="color: #800000;">'</span><span style="color: #000000;">)
                    logs.writelines([</span><span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span>,str(datetime.now()),<span style="color: #800000;">'</span><span style="color: #800000;">    web servier is down ,error status count:</span><span style="color: #800000;">'</span>,str(error_status_count),<span style="color: #800000;">'</span><span style="color: #800000;">    status number:</span><span style="color: #800000;">'</span><span style="color: #000000;">,str(status)])
                    logs.close()
            </span><span style="color: #0000ff;">except</span><span style="color: #000000;">:
                error_status_count</span>+=1    <span style="color: #008000;">#</span><span style="color: #008000;">网页状态错误次数进行累加</span>
                logs=open(<span style="color: #800000;">'</span><span style="color: #800000;">./logs.txt</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">a+</span><span style="color: #800000;">'</span><span style="color: #000000;">)
                logs.writelines([</span><span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span>,str(datetime.now()),<span style="color: #800000;">'</span><span style="color: #800000;">    web servier is down ,error status count:</span><span style="color: #800000;">'</span><span style="color: #000000;">,str(error_status_count)])
                logs.close()
            count</span>+=1
        <span style="color: #0000ff;">if</span> error_status_count&gt;=3: <span style="color: #008000;">#</span><span style="color: #008000;">网页状态错误超过3次自动发送报警邮件</span>
            logs=open(<span style="color: #800000;">'</span><span style="color: #800000;">./logs.txt</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">a+</span><span style="color: #800000;">'</span><span style="color: #000000;">)
            logs.writelines([</span><span style="color: #800000;">'</span><span style="color: #800000;">\n</span><span style="color: #800000;">'</span>,<span style="color: #800000;">'</span><span style="color: #800000;">error status count is :</span><span style="color: #800000;">'</span>,str(error_status_count),<span style="color: #800000;">'</span><span style="color: #800000;">    sending email,the program wiil try to monint the server after half an hour</span><span style="color: #800000;">'</span><span style="color: #000000;">])
            logs.close()<br />            showwarning('attention',['tzx webserver is down!',str(datetime.now())])
            sendmail()
            time.sleep(</span>1800)      <span style="color: #008000;">#</span><span style="color: #008000;">邮件发送后半小时再后再次监控网页</span>
    </pre>
</div>
<p>&nbsp;vsersion 3&nbsp;增加对https的支持和超时时间</p>
<div class="cnblogs_Highlighter">
<div class="cnblogs_Highlighter">
<pre class="brush:bash;gutter:true;">#coding:utf-8
#author:ID404
#python verson 2.7.9
#程序主要监控网页状态码，200为正常，否则视为服务器挂了。每隔70秒查询一次，若发现三次连续的查询中都报错误，则通过预先设定的邮箱发送警告邮件。邮件发送后隔30分钟再次监控设定网页。

import smtplib
import urllib2
from datetime import *
import time
from tkMessageBox import *
import ssl

def sendmail():

    send_mail="send_system@126.com"
    send_mail_passwd="123456"
    receive_mail='rec@126.com'
    send_mail_server='smtp.126.com'

    mail_to = smtplib.SMTP(send_mail_server,25) 
    mail_to.login(send_mail,send_mail_passwd) 
    msg ="From: send_system &lt;"+send_mail+"""&gt; 
To: &lt;"""+receive_mail+"""&gt;
Subject: web server is down

web server is down 
"""
    mail_to.sendmail(send_mail,receive_mail,msg)
    mail_to.close()

if __name__ == '__main__':
    logs=open('./logs.txt','a+')
    logs.writelines(['\n',str(datetime.now()),'    the program is running'])
    logs.close()
    while 1:
        count=0
        error_status_count=0
        while count&lt;3:
            time.sleep(70)      #每隔70秒监控一次服务器
            context = ssl._create_unverified_context()
            try:
                status=urllib2.urlopen("https://192.168.0.8",timeout=5,context=context).code   #收集监控网址的网页状态码
                if status==200:
                    logs=open('./logs.txt','a+')
                    logs.writelines(['\n',str(datetime.now()),'    web server is functional'])
                    logs.close()                    
                if status&lt;&gt;200:
                    error_status_count+=1
                    logs=open('./logs.txt','a+')
                    logs.writelines(['\n',str(datetime.now()),'    web servier is down ,error status count:',str(error_status_count),'    status number:',str(status)])
                    logs.close()
            except:
                error_status_count+=1    #网页状态错误次数进行累加
                logs=open('./logs.txt','a+')
                logs.writelines(['\n',str(datetime.now()),'    web servier is down ,error status count:',str(error_status_count)])
                logs.close()
            count+=1
        if error_status_count&gt;=3: #网页状态错误超过3次自动发送报警邮件
            logs=open('./logs.txt','a+')
            logs.writelines(['\n','error status count is :',str(error_status_count),'    sending email,the program wiil try to monint the server after half an hour'])
            logs.close()
            showwarning('attention',['tzx webserver is down!',str(datetime.now())])
            sendmail()
            time.sleep(1800)      #邮件发送后半小时再后再次监控网页
   
</pre>
</div>
<p>　　</p>
</div>
    
