---
layout: post
title: 利用python 通过邮件执行系统命令
keywords:
description:
categories:
---
<p>实现思路：通过检测收件箱中的指定用户发过来的邮件，检测邮件标题，执行指定命令。程序定时检测收件箱中的邮件，分离收件箱中第一封邮件的发件人和标题，若发件人不是指定用户则忽略该邮件;若发件人匹配，检测邮件中的标题,并执行标题中指定指定命令，同时会发送两封邮件出去，一封无意义标题的邮件给自己，防止重复执行命令，一封发到指定用户，告知该用户相应命令已执行。</p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #008000;">#</span><span style="color: #008000;"> -*- coding: cp936 -*-</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> os, sys, string
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> poplib
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> smtplib
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> time

</span><span style="color: #0000ff;">def</span> receive_mail():                 <span style="color: #008000;">#</span><span style="color: #008000;">检测邮箱是否接收到指定邮箱发过来的命令邮件</span>
    host = <span style="color: #800000;">"</span><span style="color: #800000;">pop3.126.com</span><span style="color: #800000;">"</span>            <span style="color: #008000;">#</span><span style="color: #008000;"> pop3服务器地址</span>
    username = <span style="color: #800000;">"</span><span style="color: #800000;">abc@126.com</span><span style="color: #800000;">"</span>         <span style="color: #008000;">#</span><span style="color: #008000;"> 用户名</span>
    password = <span style="color: #800000;">"</span><span style="color: #800000;">password</span><span style="color: #800000;">"</span>            <span style="color: #008000;">#</span><span style="color: #008000;"> 密码</span>
<span style="color: #000000;">
    pp </span>= poplib.POP3(host)         <span style="color: #008000;">#</span><span style="color: #008000;"> 创建一个pop3对象，这个时候实际上已经连接上服务器了</span>
    pp.set_debuglevel(1)            <span style="color: #008000;">#</span><span style="color: #008000;"> 设置调试模式，可以看到与服务器的交互信息</span>
    pp.user(username)               <span style="color: #008000;">#</span><span style="color: #008000;"> 向服务器发送用户名</span>
    pp.pass_(password)              <span style="color: #008000;">#</span><span style="color: #008000;"> 向服务器发送密码</span>
<span style="color: #000000;">
    ret </span>= pp.stat()               <span style="color: #008000;">#</span><span style="color: #008000;"> 获取服务器上信件信息，返回是一个列表，第一项是一共有多上封邮件，第二项是共有多少字节</span>
    down = pp.retr(ret[0])        <span style="color: #008000;">#</span><span style="color: #008000;">获取第一封邮件</span>

    <span style="color: #008000;">#</span><span style="color: #008000;"> 输出邮件内容</span>
    <span style="color: #008000;">#</span><span style="color: #008000;">for line in down[1]:</span>
    <span style="color: #008000;">#</span><span style="color: #008000;">   print line</span>
<span style="color: #000000;">

    getfrom</span>=down[1][9].decode(<span style="color: #800000;">'</span><span style="color: #800000;">utf-8</span><span style="color: #800000;">'</span><span style="color: #000000;">)0
    getsubject</span>=down[1][11].decode(<span style="color: #800000;">'</span><span style="color: #800000;">utf-8</span><span style="color: #800000;">'</span><span style="color: #000000;">)
    pp.quit()  </span><span style="color: #008000;">#</span><span style="color: #008000;"> 退出</span>
  
    <span style="color: #0000ff;">if</span> getfrom!=<span style="color: #800000;">'</span><span style="color: #800000;">From: "=?utf-8?B?5qKB6ZSm5r2u?=" &lt;cde@126.com&gt;</span><span style="color: #800000;">'</span><span style="color: #000000;">:
        </span><span style="color: #0000ff;">pass</span>
    <span style="color: #0000ff;">else</span><span style="color: #000000;">:
        </span><span style="color: #0000ff;">if</span> getsubject==<span style="color: #800000;">'</span><span style="color: #800000;">Subject: reboot</span><span style="color: #800000;">'</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">return</span> 1
        <span style="color: #0000ff;">elif</span> getsubject==<span style="color: #800000;">'</span><span style="color: #800000;">Subject: restartmq</span><span style="color: #800000;">'</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">return</span> 2
        <span style="color: #0000ff;">elif</span> getsubject==<span style="color: #800000;">'</span><span style="color: #800000;">Subject: ifconfig</span><span style="color: #800000;">'</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">return</span> 3
        <span style="color: #0000ff;">else</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> 0


</span><span style="color: #0000ff;">def</span><span style="color: #000000;"> sendmail():

    send_mail</span>=<span style="color: #800000;">"</span><span style="color: #800000;">abc@126.com</span><span style="color: #800000;">"</span>      <span style="color: #008000;">#</span><span style="color: #008000;">发件邮箱</span>
    send_mail_passwd=<span style="color: #800000;">"</span><span style="color: #800000;">password</span><span style="color: #800000;">"</span>            <span style="color: #008000;">#</span><span style="color: #008000;">发件邮箱密码</span>
    receive_mail=<span style="color: #800000;">'</span><span style="color: #800000;">abc@126.com</span><span style="color: #800000;">'</span>  <span style="color: #008000;">#</span><span style="color: #008000;">接收邮箱    </span>
    send_mail_server=<span style="color: #800000;">'</span><span style="color: #800000;">smtp.126.com</span><span style="color: #800000;">'</span>            <span style="color: #008000;">#</span><span style="color: #008000;">发件邮箱smtp服务器</span>
<span style="color: #000000;">    
    mail_to </span>= smtplib.SMTP(send_mail_server,25<span style="color: #000000;">)         
    mail_to.login(send_mail,send_mail_passwd)
    msg </span>= <span style="color: #800000;">"</span><span style="color: #800000;">From: 123@123.com &lt;</span><span style="color: #800000;">"</span>+send_mail+<span style="color: #800000;">"""</span><span style="color: #800000;">&gt;
To: &lt;</span><span style="color: #800000;">"""</span>+receive_mail+<span style="color: #800000;">"""</span><span style="color: #800000;">&gt;
Subject: igorn mess

igorn mess
</span><span style="color: #800000;">"""</span><span style="color: #000000;">
    mail_to.sendmail(send_mail,receive_mail,msg)
    mail_to.close()

    
    
</span><span style="color: #0000ff;">def</span><span style="color: #000000;"> sendreply():

    send_mail</span>=<span style="color: #800000;">"</span><span style="color: #800000;">abc@126.com</span><span style="color: #800000;">"</span>      <span style="color: #008000;">#</span><span style="color: #008000;">发件邮箱</span>
    send_mail_passwd=<span style="color: #800000;">"</span><span style="color: #800000;">password</span><span style="color: #800000;">"</span>            <span style="color: #008000;">#</span><span style="color: #008000;">发件邮箱密码</span>
    receive_mail=<span style="color: #800000;">'</span><span style="color: #800000;">cde@126.com</span><span style="color: #800000;">'</span>  <span style="color: #008000;">#</span><span style="color: #008000;">接收邮箱    </span>
    send_mail_server=<span style="color: #800000;">'</span><span style="color: #800000;">smtp.126.com</span><span style="color: #800000;">'</span>            <span style="color: #008000;">#</span><span style="color: #008000;">发件邮箱smtp服务器</span>
<span style="color: #000000;">    
    mail_to </span>= smtplib.SMTP(send_mail_server,25<span style="color: #000000;">)         
    mail_to.login(send_mail,send_mail_passwd)
    msg </span>= <span style="color: #800000;">"</span><span style="color: #800000;">From: 123@123.com &lt;</span><span style="color: #800000;">"</span>+send_mail+<span style="color: #800000;">"""</span><span style="color: #800000;">&gt;
To: &lt;</span><span style="color: #800000;">"""</span>+receive_mail+<span style="color: #800000;">"""</span><span style="color: #800000;">&gt;
Subject: order excu

order excu
</span><span style="color: #800000;">"""</span><span style="color: #000000;">
    mail_to.sendmail(send_mail,receive_mail,msg)
    mail_to.close()


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span>==<span style="color: #800000;">'</span><span style="color: #800000;">__main__</span><span style="color: #800000;">'</span><span style="color: #000000;">:
    </span><span style="color: #0000ff;">while</span> 1<span style="color: #000000;">:
        time.sleep(</span>5<span style="color: #000000;">)
        </span><span style="color: #0000ff;">if</span> receive_mail()==1<span style="color: #000000;">:
            sendmail()
            sendreply()
            os.system(</span><span style="color: #800000;">'</span><span style="color: #800000;">shutdown -r now</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">elif</span> receive_mail()==2<span style="color: #000000;">:
            sendmail()
            sendreply()
            os.system(</span><span style="color: #800000;">'</span><span style="color: #800000;">restartmq</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">elif</span> receive_mail()==3<span style="color: #000000;">:
            sendmail()
            sendreply()
            os.system(</span><span style="color: #800000;">'</span><span style="color: #800000;">ifconfig</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">pass</span></pre>
</div>
<p>&nbsp;</p>
    
